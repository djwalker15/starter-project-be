name: Deploy to Cloud Run

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag (e.g., v1)"
        required: true
        default: "v1"
  push:
    branches: [ main ]
    paths:
      - "app/**"
      - "Dockerfile"
      - "requirements.txt"
      - ".github/workflows/deploy.yml"

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  SERVICE: ${{ secrets.CLOUD_RUN_SERVICE }}
  REPO: ${{ secrets.ARTIFACT_REPO }}
  IMAGE: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.ARTIFACT_REPO }}/${{ secrets.CLOUD_RUN_SERVICE }}:${{ github.sha }}
  CLOUDSQL_CONNECTION_NAME: ${{ secrets.CLOUDSQL_CONNECTION_NAME }}
  # Plain (non-secret) envs as a comma-separated KEY=VALUE list
  GCP_ENV_VARIABLES: ${{ secrets.GCP_ENV_VARIABLES }}
  # Secret Manager mappings as a comma-separated list:
  # e.g., DB_PASSWORD=projects/$PROJECT_ID/secrets/db_password:latest,JWT_SECRET=jwt_secret:1
  GCP_SECRET_VARS: ${{ secrets.GCP_SECRET_VARS }}

jobs:
  deploy:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main') }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # needed for WIF

    steps:
      - uses: actions/checkout@v4

      # --- Auth via Workload Identity Federation ---
      - id: auth-wif
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Configure gcloud
        run: |
          gcloud config set project "$PROJECT_ID"
          gcloud config set run/region "$REGION"

      - name: Ensure Artifact Registry repo exists
        run: |
          gcloud artifacts repositories describe "$REPO" --location="$REGION" \
          || gcloud artifacts repositories create "$REPO" \
               --repository-format=docker \
               --location="$REGION" \
               --description="Docker repo for $SERVICE"

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker "${REGION}-docker.pkg.dev" --quiet

      - name: Build and Push
        run: |
          docker build -t "$IMAGE" .
          docker push "$IMAGE"

      - name: Deploy to Cloud Run (with Secret Manager + plain envs)
        env:
          PROJECT_ID: ${{ env.PROJECT_ID }}
          REGION: ${{ env.REGION }}
          SERVICE: ${{ env.SERVICE }}
          IMAGE: ${{ env.IMAGE }}
          CLOUDSQL_CONNECTION_NAME: ${{ env.CLOUDSQL_CONNECTION_NAME }}
          GCP_ENV_VARIABLES: ${{ env.GCP_ENV_VARIABLES }}
          GCP_SECRET_VARS: ${{ env.GCP_SECRET_VARS }}
        run: |
          set -euo pipefail

          # Build optional flags safely
          EXTRA_FLAGS=()

          # Add Cloud SQL attachment if provided
          if [[ -n "${CLOUDSQL_CONNECTION_NAME:-}" ]]; then
            EXTRA_FLAGS+=( --add-cloudsql-instances="${CLOUDSQL_CONNECTION_NAME}" )
          fi

          # Add non-secret env vars (KEY=VALUE,KEY2=VALUE2)
          if [[ -n "${GCP_ENV_VARIABLES:-}" ]]; then
            EXTRA_FLAGS+=( --set-env-vars="${GCP_ENV_VARIABLES}" )
          fi

          # Add Secret Manager envs (ENV=SECRET[:VERSION],ENV2=projects/ID/secrets/NAME:VERSION,...)
          if [[ -n "${GCP_SECRET_VARS:-}" ]]; then
            EXTRA_FLAGS+=( --set-secrets="${GCP_SECRET_VARS}" )
          fi

          gcloud run deploy "${SERVICE}" \
            --image="${IMAGE}" \
            --region="${REGION}" \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            "${EXTRA_FLAGS[@]}"