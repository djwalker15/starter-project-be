name: Deploy to Cloud Run

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag (e.g., v1)"
        required: true
        default: "v1"
  push:
    branches: [ main ]
    paths:
      - "app/**"
      - "alembic/**"
      - "alembic.ini"
      - "Dockerfile"
      - "requirements.txt"
      - ".github/workflows/deploy.yml"

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  SERVICE: ${{ secrets.CLOUD_RUN_SERVICE }}
  REPO: ${{ secrets.ARTIFACT_REPO }}
  IMAGE: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.ARTIFACT_REPO }}/${{ secrets.CLOUD_RUN_SERVICE }}:${{ github.sha }}
  CLOUDSQL_CONNECTION_NAME: ${{ secrets.CLOUDSQL_CONNECTION_NAME }}
  GCP_ENV_VARIABLES: ${{ secrets.GCP_ENV_VARIABLES }}
  GCP_SECRET_VARS: ${{ secrets.GCP_SECRET_VARS }}

jobs:
  deploy:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main') }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - id: auth-wif
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Configure gcloud
        run: |
          gcloud config set project "$PROJECT_ID"
          gcloud config set run/region "$REGION"

      - name: Configure Docker
        run: gcloud auth configure-docker "${REGION}-docker.pkg.dev" --quiet

      - name: Build and Push
        run: |
          docker build -t "$IMAGE" .
          docker push "$IMAGE"

      # --- Migration Job ---
      - name: Run DB Migrations
        run: |
          JOB_NAME="${SERVICE}-migrator"
          
          # Build flags for the JOB (Must use --set-cloudsql-instances)
          EXTRA_FLAGS=()
          if [[ -n "${CLOUDSQL_CONNECTION_NAME:-}" ]]; then
            EXTRA_FLAGS+=( --set-cloudsql-instances="${CLOUDSQL_CONNECTION_NAME}" )
            EXTRA_FLAGS+=( --set-env-vars="CLOUDSQL_CONNECTION_NAME=${CLOUDSQL_CONNECTION_NAME}" )
          fi
          if [[ -n "${GCP_ENV_VARIABLES:-}" ]]; then
            EXTRA_FLAGS+=( --set-env-vars="${GCP_ENV_VARIABLES}" )
          fi
          if [[ -n "${GCP_SECRET_VARS:-}" ]]; then
            EXTRA_FLAGS+=( --set-secrets="${GCP_SECRET_VARS}" )
          fi

          echo "Deploying migration job: $JOB_NAME"
          gcloud run jobs deploy "$JOB_NAME" \
            --image="$IMAGE" \
            --region="$REGION" \
            --command="alembic" \
            --args="upgrade,head" \
            --max-retries=0 \
            "${EXTRA_FLAGS[@]}"

          echo "Executing migration job..."
          gcloud run jobs execute "$JOB_NAME" --region="$REGION" --wait

      # --- Service Deployment ---
      - name: Deploy to Cloud Run
        run: |
          set -euo pipefail

          # Build flags for the SERVICE (Can use --add-cloudsql-instances)
          EXTRA_FLAGS=()
          if [[ -n "${CLOUDSQL_CONNECTION_NAME:-}" ]]; then
            EXTRA_FLAGS+=( --add-cloudsql-instances="${CLOUDSQL_CONNECTION_NAME}" )
            # CRITICAL FIX: Pass the connection name as an Env Var to the app
            EXTRA_FLAGS+=( --set-env-vars="CLOUDSQL_CONNECTION_NAME=${CLOUDSQL_CONNECTION_NAME}" )
          fi
          if [[ -n "${GCP_ENV_VARIABLES:-}" ]]; then
            EXTRA_FLAGS+=( --set-env-vars="${GCP_ENV_VARIABLES}" )
          fi
          if [[ -n "${GCP_SECRET_VARS:-}" ]]; then
            EXTRA_FLAGS+=( --set-secrets="${GCP_SECRET_VARS}" )
          fi

          gcloud run deploy "${SERVICE}" \
            --image="${IMAGE}" \
            --region="${REGION}" \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            "${EXTRA_FLAGS[@]}"